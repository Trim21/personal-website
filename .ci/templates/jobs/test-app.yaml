jobs:
  - job: 'App'
    pool:
      vmImage: 'ubuntu-16.04' # other options: 'macOS-10.13', 'vs2017-win2016'

    steps:
      - task: DockerCompose@0
        displayName: Setup Containers
        inputs:
          action: Run services
          dockerComposeFile: '$(Build.Repository.LocalPath)/.ci/composes/docker-compose.yaml'

      - template: /.ci/templates/steps/install-project.yaml

      - bash: |
          set -ex
          sudo apt-get install mysql-client -y
          mkdir -p ./tests_data
          curl -sSL https://github.com/Trim21/personal-website/releases/download/test_data/mysql-1.sql -o ./tests_data/all.sql

          MYSQL_CLIENT_ARGS="--host=127.0.0.1 --port=3307 --database=$MYSQL_DB -u root -p$MYSQL_PASSWORD"
          mysql $MYSQL_CLIENT_ARGS -e "SET GLOBAL sql_mode=(SELECT REPLACE(@@sql_mode,'NO_AUTO_CREATE_USER',''));"
          mysql $MYSQL_CLIENT_ARGS < ./tests_data/all.sql
        displayName: Download Test Data

      - script: coverage run -m pytest --junitxml=junit/test_report.xml
        displayName: Unittest

      - task: PublishTestResults@2
        condition: succeededOrFailed()
        inputs:
          testResultsFiles: 'junit/test_*.xml'
          testRunTitle: 'Publish test results for Python $(python.version)'

      - template: /.ci/templates/steps/codecov.yaml
